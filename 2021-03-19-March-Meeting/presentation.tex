% !TEX output_directory=output
\documentclass{beamer}

% TODO
% * clean up figures, especially handwritten ones
% * Minimize text in slides
% * Make slides stand alone (provide enough information to get gist)
% * Make it simple (e.g. “higher is better in this plot”, “reward of 4 means 0.9999”)

\usepackage[beamer]{kaufman}

% uncomment to include notes in PDF
% \setbeameroption{show notes}

\bibliography{../refs.bib}
\graphicspath{{../graphics/}}

% TODO add funding acknowledgement, shrink this and show logos too...

\title[RL for Quantum Control in NMR]{Using Reinforcement Learning for Quantum Control in Magnetic Resonance [DRAFT]}
\author[Will Kaufman]{Will Kaufman\inst{1} \and Benjamin Alford\inst{1} \and Pai Peng\inst{2} \and Xiaoyang Huang\inst{2} \and Linta Joseph\inst{1} \and Paola Cappellaro\inst{2} \and Chandrasekhar Ramanathan\inst{1}}
\date[March Meeting 2021]{APS March Meeting 2021 \\
Session X32: Quantum Machine Learning III}
\institute[Dartmouth and MIT]{
\inst{1}Department of Physics and Astronomy, Dartmouth College \\
Hanover, NH 03755, USA
\and
\inst{2}Research Laboratory of Electronics, Massachusetts Institute of Technology \\
Cambridge, Massachusetts 02139, USA}

% \titlegraphic{
% \includegraphics[height=.1\textheight]{lonepine.pdf}
% \includegraphics[height=.1\textheight]{mit_logo.png}
% }

\begin{document}

\frame{\titlepage}

\begin{frame}
\frametitle{Table of Contents}
\tableofcontents
\end{frame}

\section{Quantum control}

\begin{frame}{Quantum control in spin systems}

\[
    H(t) = H_\text{system} + H_\text{control}(t)
\]

Can use $H_\text{control}(t)$ to achieve state-to-state transfer ($\rho_0 \to \rho$) or a unitary transformation $U$.

% TODO remove state-to-state transfer? Just mention unitary/Hamiltonian engineering
% TODO also just focusing on closed system/unitary dynamics
% TODO many body dynamics, global control only
% TODO also include spectrum with/without refocusing dipolar interactions?

\begin{figure}
\centering
\input{spin_system.tex}
\end{figure}

\note{Different types of spin systems: \emph{strongly} coupled (solid state NMR) and \emph{weakly} coupled (ESR, NV/P1 centers)

Don't have universal control, only global control (affects all spins).}

\end{frame}

\begin{frame}{Hamiltonian engineering}

% TODO remove slide, put important info on previous...

Use $H_\text{control}(t)$ to evolve the system under a desired effective Hamiltonian $H_\text{eff}$.

\begin{itemize}
    \item Time suspension ($H_\text{eff} = 0$)
    \item Sensing (e.g. $H_\text{eff} = \beta \textcolor[rgb]{0,0.69,0}{H_{\text{CS}}}$)
    \item Quantum simulation
\end{itemize}

\note{
Applicable to many-body spin systems. \\
Mention sensing in context of canceling dipolar interactions.}

\end{frame}

\begin{frame}{Average Hamiltonian theory}

% TODO explain what interaction frame is, put in note...

\begin{figure}
\centering
\scalebox{.7}{
\input{AHT_diagram.tex}
}
\end{figure}
% For some pulse sequences with cycle time $t_c$, the time-evolution operator for one cycle can be given in terms of an average Hamiltonian
% \[
%     U(t_c) = \exp\left( -i t_c (\overline{H}^{(0)} +
%         \overline{H}^{(1)} + \dots) \right)
% \]
\begin{align*}
    \overline{H}^{(0)} &= \frac{1}{t_c} \int_0^{t_c}
        \widetilde{H}_\text{system}(t) dt \\
    \overline{H}^{(1)} &= \frac{1}{2it_c} \int_0^{t_c} dt_1 \int_0^{t_1} dt_2
        [\widetilde{H}_\text{system}(t_1), \widetilde{H}_\text{system}(t_2)]
\end{align*}

% TODO include second order term
% and include diagram showing difficulty with different time terms

\note{
Average Hamiltonian Theory (AHT) has been used extensively for Hamiltonian engineering

Note how the first-order term has commutator of toggled Hamiltonians at different times. This is straightforward to calculate with a 4-pulse sequence, but gets analytically intractable for longer sequences, and for higher-order terms.
}

\end{frame}

\begin{frame}{Existing approaches to Hamiltonian engineering}

% TODO
% * Need to shorten this probably
% * Have this slide be more about shortfalls of AHT
% * Move yxx48 pulse sequence to RL

\begin{itemize}
    \item WAHUHA 4-pulse sequence (\cite{PhysRevLett.20.180})
    \[H_\text{eff} = \textcolor[rgb]{0,0.69,0}{H_{\text{CS}}'}\]
    
    \item CORY 48-pulse sequence (\cite{CORY1990205})
    \[H_\text{eff} = 0\]
    designed analytically using AHT to be robust to errors
    % TODO what is CORY48 robust to?
    
    % \item More recent pulse sequences for sensing from \cite{O_Keeffe_2019} and \cite{PhysRevLett.119.183603} by applying linear programming techniques
    % % TODO what did OKeeffe and Choi do? Sensing?
    
    \item New yxx48 pulse sequence (\cite{peng2021deep})
    \[H_\text{eff} = 0\]
    designed using deep reinforcement learning and evolutionary algorithms
\end{itemize}

\note{CORY-48 designed for time suspension while being robust to rotation and offset errors}

\end{frame}



\begin{frame}{Existing approaches (cont.)}

\begin{figure}
\centering
\includegraphics[width=.7\textwidth]{decay_plot.pdf}
\end{figure}

Shorter, analytically tractable $\iff$ Longer, complicated

\note{
AHT has led to useful pulse sequences, but\dots
\begin{itemize}
    \item Typically only consider the lowest order term in average Hamiltonian (higher-order terms get intractable quickly)
    \item Longer pulse sequences have been shown to improve fidelity, but difficult to identify/analyze in AHT
\end{itemize}
}

% TODO include figure showing large number of possibilities?

\end{frame}

\section{Reinforcement learning for quantum control}


\begin{frame}{Reinforcement learning for quantum control}

\begin{figure}
\centering
\includegraphics[width=.8\textwidth]{rl.png}

From \cite{sutton2018reinforcement}.
% \caption{}
\end{figure}

\begin{itemize}
    \item State $\to$ propagator
    \item Action $\to$ rf-pulse
    \item Reward $\to$ propagator fidelity
\end{itemize}
    
\end{frame}

\begin{frame}{Reinforcement learning for quantum control (cont.)}

% TODO can I include this info in above slide, then remove this slide?

\[
    \text{fidelity}(U, U_\text{target}) = \Re{
        \frac{\Tr{U_\text{target}^\dagger U(t)}}{\Tr{\identity}}
    }
\]
For RL algorithm performance, use log infidelity as ``reward''
\[
    r = -\log \left( 1 - \text{fidelity} \right)
\]

\pause

\[
r = 4 \iff \text{fidelity} = 0.\underline{9999}
\]

% \note{Can apply RL to discrete control problem (pulse sequences)
% or continuous control (shaped pulses, continuously-varying control
% Hamiltonians)}

\end{frame}

\begin{frame}{Constructing pulse sequences using RL}

Implemented AlphaZero algorithm (\cite{Silver1140}) designed to play Chess, Shogi, and Go.
% TODO insert graphic of some sort...
% TODO call out to potential for tailored pulse sequences for particular systems, and robust to certain things...

\begin{figure}
\centering
\scalebox{.75}{
\input{mcts.tex}
}
\end{figure}

\note{
Action space is delay, $\pm$X, $\pm$Y. Target unitary for time suspension is identity.

Each iteration of algorithm involves collecting data in a tree search and training neural networks on the collected data. Neural network maps state to policy (what pulse should I apply next?) and value (how good will this pulse sequence be?).

With tree structure, can optionally add AHT constraints to search.

% Collects data on pulse sequences, balancing \emph{exploration} of new
% pulse sequences and \emph{exploitation} of learnings (via neural
% networks), and trains neural networks on collected data to learn from
% recent experiences.
}

\end{frame}


\begin{frame}{Comparison between RL approaches}

% TODO make this prettier...
\begin{tabular}{p{.2\textwidth} p{.5\textwidth} p{.25\textwidth}}
    Characteristic & Evolutionary Reinforcement Learning & AlphaZero \\
    \hline
    State representation & Sequence of previous pulses & Same \\
    Action space & Delay or $\pi/2$-pulse along $\pm$X, $\pm$Y & Same \\
    Learning method & Evolutionary algorithms (gradient-free) & Tree search and experience replay (gradient based) \\
    % Neural network architecture  % TODO what is their NN architecture?
    Prior knowledge & Builds longer sequences from shorter ones & Uses AHT to prune tree search
\end{tabular}

\end{frame}


\begin{frame}{Computational results}

% TODO include results for weakly and strongly coupled spin systems

Searching for 48-pulse sequence for time suspension (\(\overline{H}=0\)) in strongly coupled spin system, identified \textrm{az48} sequence after 14 hours
on 16 Intel Xeon E5-2640V3 (2.6GHz) CPUs.

\begin{figure}
\centering
\includegraphics[width=.49\textwidth]{rot_errors.pdf}
\includegraphics[width=.49\textwidth]{phase_transients.pdf}
\end{figure}

\end{frame}

\begin{frame}{Computational results (cont.)}

\{ Plot of fidelity vs pulse sequence length \}

Currently gathering data for this plot

\end{frame}

\begin{frame}{Experimental results}

\{decay plots, compare with yxx48 and CORY-48\}

% waiting on results from (hopefully) better pulse sequence

\end{frame}

\begin{frame}[allowframebreaks]
\frametitle{References}

\printbibliography

\end{frame}
















\section{Appendix}


\begin{frame}{Quantum control in spin systems}


\begin{align*}
    H_\text{system} &= \sum_i \delta_i I_z^i + \sum_{i,j} d_{ij} \left( 3I_z^iI_z^j - \mathbf{I^i} \cdot \mathbf{I^j} \right) \\
        &= H_\text{CS} + H_\text{D}
\end{align*}

\[
    H_\text{control}(t) = -B_1(t) \sum_i \gamma_n^i I_x^i -B_2(t) \sum_i \gamma_n^i I_y^i
\]

\end{frame}


\begin{frame}{Average Hamiltonian Theory (AHT)}

The time-evolution operator (or propagator) follows the differential
equation \[
i \frac{d}{dt} U(t) = H(t)U(t)
\] \[
U(0) = \identity
\]

The Magnus Expansion gives an exponential solution for the propagator
via an average Hamiltonian \(\overline{H}\) at time \(t\) \[
U(t) = \exp\left( -i \overline{H} t \right)
\] with \(\overline{H} = \overline{H}^0 + \overline{H}^1 + \dots\).

The series converges rapidly when \(t||H|| \ll 1\).

\end{frame}

\begin{frame}{AHT (cont.)}

We often work in the interaction frame of the control Hamiltonian, with transformation operator

\begin{align*}
    \frac{d}{dt} U_\text{control}(t) &=
        -i H_\text{control}(t)U_\text{control}(t) \\
    U_\text{control}(0) &= \identity
\end{align*}

So the Hamiltonian in the interaction frame becomes

\[
    \widetilde{H}(t) = \widetilde{H}_\text{system}(t) = U_\text{control}(t)^\dagger H_\text{system} U_\text{control}(t)
\]

\cite{brinkmann_2016}.
\end{frame}

\begin{frame}{AHT: Pulse sequences}

% TODO add density operator, diagrams

If a pulse sequence is both cyclic and periodic \cite{gerstein-dybowski}
\begin{align*}
    U_\text{control}(t_c) &= T\exp \left(
        -i \int_0^{t_c} H_\text{control}(t) dt \right) = \pm \identity
         \, \text{(cyclic)} \\
    H_\text{control}(t) &= H_\text{control}(t + Nt_c) \, \text{(periodic)}
\end{align*}
then the interaction frame and the lab frame coincide at multiples of
the cycle time, and the propagator can be given by
\[
    U(t_c) = \exp\left( -i t_c (\overline{H}^{(0)} +
        \overline{H}^{(1)} + \dots) \right)
\]
Higher-order terms for average Hamiltonian become nasty\dots

\end{frame}

\begin{frame}{AHT: Pulse sequences (cont.)}

\begin{align*}
    \overline{H}^{(0)} &= 1/t_c \int_0^{t_c}
        \widetilde{H}_\text{system}(t) dt \\
    \overline{H}^{(1)} &= 1/2it_c \int_0^{t_c} dt_1 \int_0^{t_1} dt_2
        [\widetilde{H}_\text{system}(t_1),
         \widetilde{H}_\text{system}(t_2)] \\
     \overline{H}^{(2)} &= \text{TODO fill this in} \\
\end{align*}

\end{frame}

\begin{frame}{AHT: Special Cases}

\begin{itemize}

\item
  Symmetric pulse sequences (\(H(\tau) = H(t_c - \tau)\)): all odd-order
  terms in average Hamiltonian are zero
\item
  Antisymmetric pulse sequences (\(H(\tau) = - H(t_c - \tau)\)): all
  terms in average Hamiltonian are zero
\end{itemize}
\end{frame}

\begin{frame}{Spin systems}

% TODO include Hcontrol <-> pulses description

Sources of error:
\begin{itemize}
    \item Rotation (``flip angle'') error: control field magnitudes and/or durations are mis-calibrated
    \item Phase transient error: rotations about quadrature axes due to circuit impedance
    \item Offset error: rotating frame does not match system frequency
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=.4\textwidth]{phase_transients_viz.png}
\caption{Ideal pulse shape (a) and phase transients (b) \cite{1976ii}.}
\end{figure}

\end{frame}

\begin{frame}{Reinforcement learning methodology}

% TODO fill in below

Working on this slide still...

State representation:

Action representation:

Spin system simulation parameters:

% TODO system/ensemble simulation

\end{frame}

\begin{frame}{Neural network structure}

\begin{figure}
\centering
\scalebox{.6}{
\input{neural_network.tex}
}
\end{figure}

\end{frame}

\begin{frame}{AlphaZero algorithm}


Explore new pulse sequences

\begin{enumerate}

\item
Start with a zero-length pulse sequence as the root node
\item
With the given root node, perform Monte Carlo Tree Search (MCTS) to
explore potential pulses

MCTS uses a neural network to estimate the prior probabilities for
selecting each pulse and the value (fidelity) for the final pulse
sequence

\item
Sample the next pulse from the root node's children weighted by
their visit counts
\item
Repeat steps 2-4 until a complete pulse sequence is determined
\item
Record the child nodes' visit counts and final pulse sequence
fidelity to a data buffer for training
\end{enumerate}

% TODO clean this slide up!
Parameters for MCTS, training, etc.
\end{frame}

\begin{frame}{AlphaZero algorithm (cont.)}

Train neural networks on collected data

\begin{itemize}

\item
Policy loss: want to minimize the difference between MCTS visit
counts \(\mathbf{p}\) and learned policy \(\pi_\theta\)
\item
Value loss: want to minimize the difference between calculated
fidelity from pulse sequence \(z\) and predicted fidelity from
neural network \(v\)
\item
L2 regularization: prevent overfitting to data
\item
\(l(\theta) = -\mathbf{p} \cdot \log\pi_\theta + (z - v)^2 + c||\theta||^2\)
\end{itemize}
\end{frame}


\begin{frame}{Neural network training}

\includegraphics[width=.49\textwidth]{loss_policy.png}
\includegraphics[width=.49\textwidth]{loss_value.png}
\end{frame}

\begin{frame}{Training performance}

\includegraphics[width=.8\textwidth]{training_fidelity.png}
\end{frame}

\begin{frame}{Pulse sequences identified using AlphaZero}

\textrm{az48} pulse sequence (for time suspension):

$ -X, \tau, Y, \tau, Y, \tau, X, \tau, Y, \tau, Y, \tau $
$ -Y, \tau, X, \tau, X, \tau, -Y, \tau, X, \tau, X, \tau $
$ Y, \tau, X, \tau, X, \tau, -Y, \tau, X, \tau, X, \tau $
$ -Y, \tau, X, \tau, -Y, \tau, X, \tau, X, \tau, -Y, \tau $
$ -X, \tau, -X, \tau, Y, \tau, Y, \tau, -X, \tau, Y, \tau $
$ Y, \tau, -Y, \tau, X, \tau, -Y, \tau, -Y, \tau, X, \tau $
$ -Y, \tau, X, \tau, X, \tau, -Y, \tau, X, \tau, X, \tau $
$ -Y, \tau, -X, \tau, -X, \tau, -Y, \tau, -X, \tau, -X, \tau $

\end{frame}

\begin{frame}{RL advantages and disadvantages}

\begin{itemize}
    \item Generalized approach to learning problem: no assumed prior knowledge
    \item Can tailor problem to specific system of interest (e.g. strongly coupled system, timing precision constraints)
    \item Robustness against known errors by including them in simulation of spin system
\end{itemize}

\pause

\begin{itemize}
    \color{red}
    \item Computationally expensive
    \item Poor accuracy of many-body spin simulations
    \item No guarantees for convergence to optimal (or good) solution
\end{itemize}

\end{frame}

\end{document}
